name: Telegram Commit Notification

on:
  push:
    branches:
      - '**'  # All branches

jobs:
  notify:
    runs-on: ubuntu-latest
    name: Send Telegram Notification
    
    steps:
      - name: Get commit info
        id: commit
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "commit_date=$(TZ='Asia/Jakarta' date +'%d %b %Y, %H:%M WIB')" >> $GITHUB_OUTPUT
          
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Get commit message (escape special characters for Telegram)
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1 | sed 's/[_*`\[]/\\&/g')
          AUTHOR="${{ github.event.head_commit.author.name }}"
          BRANCH="${{ steps.commit.outputs.branch }}"
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          COMMIT_DATE="${{ steps.commit.outputs.commit_date }}"
          REPO="${{ github.repository }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          
          # Build message
          MESSAGE="ğŸ”” *New Commit - ${REPO#*/}*%0A%0AğŸ“Œ *Branch:* ${BRANCH}%0AğŸ‘¤ *Author:* ${AUTHOR}%0AğŸ“ *Message:* ${COMMIT_MSG}%0A%0AğŸ”— *Commit:* ${SHORT_SHA}%0AğŸ“… *Time:* ${COMMIT_DATE}%0A%0AğŸ”— [View Commit](${COMMIT_URL})"

          # Send to Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview="true"
